---
- name: Install CNI plugin
  when: "'master' in group_names"
  shell: |
    if [ "{{ cni_plugin }}" = "calico" ]; then
      # Install Operator
      kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.5/manifests/tigera-operator.yaml
      # Download custom-resources.yaml
      curl -sS -o /tmp/custom-resources.yaml \
        https://raw.githubusercontent.com/projectcalico/calico/v3.28.5/manifests/custom-resources.yaml

      # Change Calico IPPool CIDR from 192.168.0.0/16 to 10.244.0.0/16
      sed -i 's/cidr: 192\.168\.0\.0\/16/cidr: 10.244.0.0\/16/' /tmp/custom-resources.yaml

      # Apply modified custom resources
      kubectl apply -f /tmp/custom-resources.yaml    else
      kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
    fi
  args:
    executable: /bin/bash
